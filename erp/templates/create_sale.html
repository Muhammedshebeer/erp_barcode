{% extends 'base.html' %}
{% block content %}
<h3>Create Sale</h3>
<form method="post" id="sale-form">{% csrf_token %}
  <div class="row mb-3">
    <div class="col-md-4">
      <label>Invoice No</label>
      <input class="form-control" name="invoice_no" placeholder="Optional - auto">
    </div>
    <div class="col-md-4">
      <label>Customer</label>
      <input class="form-control" name="customer_name">
    </div>
    <div class="col-md-4">
      <label>Scan Barcode</label>
      <input id="barcode-input" class="form-control" placeholder="Scan or type barcode and press Enter">
    </div>
  </div>

  <table class="table" id="items-table">
    <thead><tr><th>Product</th><th>Price</th><th>Qty</th><th>Subtotal</th><th></th></tr></thead>
    <tbody></tbody>
  </table>

  <div class="d-flex justify-content-between align-items-center">
    <div>
      <button type="button" id="add-row" class="btn btn-secondary">Add line</button>
    </div>
    <div>
      <strong>Total: <span id="total">0.00</span></strong>
    </div>
  </div>

  <div class="mt-3">
    <button class="btn btn-success">Save Sale</button>
  </div>
</form>
{% endblock %}

{% block scripts %}

<script>
const products = JSON.parse(document.getElementById('products-data').textContent); // list of products
let lineIndex = 0;

function createRow(productId=null, price=0, qty=1){
    const tbody = document.querySelector('#items-table tbody');
    const tr = document.createElement('tr');

    tr.innerHTML = `
    <td>
      <select name="item-product-${lineIndex}" class="form-select form-select-sm product-select">
        ${products.map(p => `<option value="${p.id}" ${productId==p.id ? 'selected' : ''}>${p.name}</option>`).join('')}

      </select>
    </td>
    <td><input name="item-price-${lineIndex}" value="${price}" class="form-control form-control-sm price-input"></td>
    <td><input name="item-qty-${lineIndex}" value="${qty}" class="form-control form-control-sm qty-input"></td>
    <td class="subtotal-cell">0.00</td>
    <td><button type="button" class="btn btn-sm btn-danger remove-row">x</button></td>
    `;
    tbody.appendChild(tr);

    // Event listeners
    tr.querySelector('.remove-row').addEventListener('click', ()=>{
        tr.remove();
        computeTotals();
    });
    tr.querySelector('.price-input').addEventListener('input', computeTotals);
    tr.querySelector('.qty-input').addEventListener('input', computeTotals);
    tr.querySelector('.product-select').addEventListener('change', function(){
        const selected = products.find(p => p.id == this.value);
        if (selected) tr.querySelector('.price-input').value = selected.price;
        computeTotals();
    });

    lineIndex++;
    computeTotals();
}

function computeTotals(){
    let total = 0;
    document.querySelectorAll('#items-table tbody tr').forEach(tr=>{
        const price = parseFloat(tr.querySelector('.price-input').value || 0);
        const qty = parseInt(tr.querySelector('.qty-input').value || 0);
        const subtotal = (price * qty) || 0;
        tr.querySelector('.subtotal-cell').innerText = subtotal.toFixed(2);
        total += subtotal;
    });
    document.getElementById('total').innerText = total.toFixed(2);
}

// Add initial empty row
document.getElementById('add-row').addEventListener('click', ()=> createRow());

// Barcode scanning: enter -> lookup via AJAX
document.getElementById('barcode-input').addEventListener('keypress', function(e){
    if (e.key === 'Enter'){
        e.preventDefault();
        const barcode = this.value.trim();
        if (!barcode) return;

        fetch(`/ajax/lookup-barcode/?barcode=${encodeURIComponent(barcode)}`)
            .then(r => r.json())
            .then(data => {
                if (data.ok){
                    // data.id = product id, data.sale_price = price
                    createRow(data.id, data.sale_price, 1);
                    this.value = '';
                } else {
                    alert(data.error || 'Product not found');
                }
            }).catch(err => {
                alert('Lookup failed');
            });
    }
});
</script>
{% endblock %}

