
{% extends 'base.html' %}
{% block content %}
<!-- Font Awesome CDN -->

<h3>Create Sale</h3>
<form method="post" id="sale-form">{% csrf_token %}
  <div class="row mb-3">
    <div class="col-md-4">
      <label>Invoice No</label>
      <input class="form-control" name="invoice_no" placeholder="Optional - auto">
    </div>
    <div class="col-md-4">
      <label>Customer</label>
      <input class="form-control" name="customer_name">
    </div>
    <div class="col-md-4">
      <label>Scan Barcode</label>
      <input id="barcode-input" class="form-control" placeholder="Scan or type barcode and press Enter">
    </div>
  </div>

  <table class="table" id="items-table">
    <thead>
      <tr>
        <th>Product</th><th>Price</th><th>Qty</th><th>Subtotal</th><th></th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="d-flex justify-content-between align-items-center">
<!--    <div>-->
<!--      <button type="button" id="add-row" class="btn btn-secondary">Add line</button>-->
<!--    </div>-->
      <div class="mt-3">
    <button class="btn btn-success">Save Sale</button>
  </div>
    <div>
      <strong>Total: <span id="total">0.00</span></strong>
    </div>
  </div>


</form>


<hr>
<h3>Previous Sales</h3>

<table class="table table-bordered" id="sales-table">
    <thead>
        <tr>
            <th>Invoice</th>
            <th>Date</th>
            <th>Customer</th>
            <th>Total</th>
            <th>View</th>
        </tr>
    </thead>
    <tbody>
    {% for s in sales %}
    <tr>
        <td>{{ s.invoice_no }}</td>
        <td>{{ s.created_at|date:"Y-m-d H:i" }}</td>
        <td>{{ s.customer_name }}</td>
        <td>{{ s.total }}</td>
        <td class="text-center">
            <button class="btn btn-sm btn-primary view-sale" data-id="{{ s.id }}">
    <i class="fa-solid fa-eye"></i>
</button>

<!-- Download button -->
<a href="{% url 'sale_pdf' s.id %}" class="btn btn-sm btn-info">
    <i class="fa-solid fa-download"></i>
</a>
        </td>
    </tr>
    {% endfor %}
</tbody>
</table>
<div class="d-flex justify-content-center mt-3">
    <nav>
        <ul class="pagination">

            {% if sales.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ sales.previous_page_number }}">«</a>
                </li>
            {% endif %}

            {% for num in sales.paginator.page_range %}
                <li class="page-item {% if sales.number == num %}active{% endif %}">
                    <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                </li>
            {% endfor %}

            {% if sales.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ sales.next_page_number }}">»</a>
                </li>
            {% endif %}

        </ul>
    </nav>
</div>


<!-- Sale Detail Modal -->
<div class="modal fade" id="saleDetailModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Sale Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body" id="sale-detail-body">
        Loading...
      </div>

    </div>
  </div>
</div>
<!-- Pass products to JS -->
<script type="application/json" id="products-data">
{{ products|safe|json_script:"products-data" }}
</script>
{% endblock %}

{% block scripts %}
<script>

  function bindViewSaleButtons() {
    document.querySelectorAll('.view-sale').forEach(btn => {
        btn.addEventListener('click', function(){
            const saleId = this.dataset.id;

            fetch(`/sales/${saleId}/detail-modal/`)
                .then(r => r.text())
                .then(html => {
                    document.getElementById('sale-detail-body').innerHTML = html;
                    new bootstrap.Modal(document.getElementById('saleDetailModal')).show();
                });
        });
    });
}

// Call initially
bindViewSaleButtons();

  // View sale modal load
document.querySelectorAll('.view-sale').forEach(btn => {
    btn.addEventListener('click', function(){
        const saleId = this.dataset.id;

        fetch(`/sales/${saleId}/detail-modal/`)
            .then(r => r.text())
            .then(html => {
                document.getElementById('sale-detail-body').innerHTML = html;

                let modal = new bootstrap.Modal(document.getElementById('saleDetailModal'));
                modal.show();
            })
            .catch(err => alert("Failed to load details"));
    });
});

function computeTotals(){
    let total = 0;
    document.querySelectorAll('#items-table tbody tr').forEach(tr=>{
        const price = parseFloat(tr.querySelector('.price-input').value || 0);
        const qty = parseInt(tr.querySelector('.qty-input').value || 0);
        const subtotal = price * qty;
        tr.querySelector('.subtotal-cell').innerText = subtotal.toFixed(2);
        total += subtotal;
    });
    document.getElementById('total').innerText = total.toFixed(2);
}

// Add or update product row function
function addOrUpdateRow(product){
    const tbody = document.querySelector('#items-table tbody');
    const lineIndex = tbody.children.length; // dynamic index

    const tr = document.createElement('tr');
    tr.dataset.productId = product.id;
    tr.innerHTML = `
        <td>
            ${product.name}
            <input type="hidden" name="item-product-${lineIndex}" value="${product.id}">
        </td>
        <td>
            <input type="number" class="form-control form-control-sm price-input" name="item-price-${lineIndex}" value="${product.sale_price}">
        </td>
        <td>
            <input type="number" class="form-control form-control-sm qty-input" name="item-qty-${lineIndex}" value="1">
        </td>
        <td class="subtotal-cell">${product.sale_price.toFixed(2)}</td>
        <td>
            <button type="button" class="btn btn-sm btn-danger remove-row">x</button>
        </td>
    `;
    tbody.appendChild(tr);

    // Event listeners
    tr.querySelector('.remove-row').addEventListener('click', ()=>{ tr.remove(); computeTotals(); });
    tr.querySelector('.price-input').addEventListener('input', computeTotals);
    tr.querySelector('.qty-input').addEventListener('input', computeTotals);

    computeTotals();
}
// Barcode input listener
document.getElementById('barcode-input').addEventListener('keypress', function(e){
    if(e.key === 'Enter'){
        e.preventDefault();
        const barcode = this.value.trim();
        if(!barcode) return;

        fetch(`/ajax/lookup-barcode/?barcode=${encodeURIComponent(barcode)}`)
            .then(r => r.json())
            .then(data => {
                if(data.ok){
                    addOrUpdateRow(data); // pass the product JSON directly
                    this.value = '';
                } else {
                    alert(data.error || 'Product not found');
                }
            }).catch(err => alert('Lookup failed'));
    }
});

// Optional: initial row button
document.getElementById('add-row').addEventListener('click', ()=>{ /* you can reuse createRow here if needed */ });

</script>
{% endblock %}
